<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk System (Samra)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:linear-gradient(135deg,#667eea,#764ba2);
            min-height:100vh;
            padding:10px;
        }
        .container{
            max-width:100%;
            width:100%;
            background:#fff;
            border-radius:12px;
            box-shadow:0 10px 30px rgba(0,0,0,0.2);
            overflow:hidden;
        }
        .login-container{
            display:flex;
            align-items:center;
            justify-content:center;
            min-height:90vh;
            padding:20px;
        }
        .login-form{
            background:#fff;
            padding:25px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.1);
            width:100%;
            max-width:380px;
        }
        .role-selector{
            display:flex;
            gap:8px;
            justify-content:center;
            margin-bottom:20px;
            flex-wrap:wrap;
        }
        .role-btn{
            flex:1;
            min-width:120px;
            padding:10px 16px;
            border:1px solid #ddd;
            border-radius:8px;
            cursor:pointer;
            background:#f8f9fa;
            font-size:14px;
            font-weight:600;
        }
        .role-btn.active{background:#4CAF50;color:#fff;border-color:#4CAF50;}
        .form-group{margin-bottom:15px;}
        label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:14px;}
        input{
            width:100%;
            padding:12px;
            border:2px solid #e1e5e9;
            border-radius:8px;
            font-size:15px;
        }
        input:focus{
            outline:none;border-color:#4CAF50;
            box-shadow:0 0 0 3px rgba(76,175,80,0.12);
        }
        .btn{
            padding:12px 18px;
            border:none;
            border-radius:8px;
            background:#4CAF50;
            color:#fff;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            margin-top:6px;
            width:100%;
        }
        .btn:hover{background:#45a049;}
        .btn-secondary{background:#2196F3;}
        .btn-secondary:hover{background:#1976D2;}
        .btn-danger{background:#f44336;}
        .btn-danger:hover{background:#d32f2f;}
        .btn-small{width:auto;font-size:12px;padding:6px 10px;margin:2px;}
        .link-btn{
            background:none;border:none;color:#2196F3;
            cursor:pointer;font-size:13px;text-decoration:underline;
            padding:0;margin-top:5px;
        }
        .dashboard{display:none;padding:20px;}
        .header{
            background:linear-gradient(135deg,#4CAF50,#45a049);
            color:#fff;
            padding:15px 20px;
            margin:-20px -20px 20px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            gap:8px;
        }
        .header h1{font-size:18px;}
        .header small{font-size:12px;opacity:0.9;}
        .logout{
            background:rgba(255,255,255,0.2);
            padding:8px 14px;
            border-radius:20px;
            cursor:pointer;
            font-size:13px;
        }
        .section{
            background:#f8f9fa;
            padding:15px;
            border-radius:10px;
            margin-bottom:15px;
        }
        .section h3{margin-bottom:10px;font-size:16px;color:#333;}
        .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .form-row{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
            gap:10px;
            margin-bottom:10px;
        }
        .stats{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px;
            margin-bottom:15px;
        }
        .stat-card{
            background:#fff;
            padding:12px;
            border-radius:8px;
            text-align:center;
            box-shadow:0 3px 10px rgba(0,0,0,0.08);
        }
        .stat-number{font-size:1.4em;font-weight:bold;color:#4CAF50;}
        .two-column{
            display:grid;
            grid-template-columns:1fr;
            gap:15px;
        }
        @media(min-width:900px){
            .two-column{grid-template-columns:1.1fr 2fr;}
        }
        .table-container{
            max-height:260px;
            overflow-y:auto;
            overflow-x:auto;
        }
        table{
            width:100%;
            border-collapse:collapse;
            background:#fff;
            font-size:13px;
        }
        th,td{
            padding:8px 6px;
            border-bottom:1px solid #e1e5e9;
            text-align:left;
        }
        th{
            background:#4CAF50;
            color:#fff;
            font-size:12px;
            position:sticky;top:0;z-index:5;
        }
        tr:hover{background:#f8f9ff;}
        .hidden{display:none !important;}
        
        /* CUSTOMER LIST */
        #customerList{
            list-style:none;
            max-height:260px;
            overflow-y:auto;
            padding:0;
        }
        #customerList li{
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding:8px 10px;
            border-radius:6px;
            margin-bottom:4px;
            background:#fff;
            box-shadow:0 2px 5px rgba(0,0,0,0.05);
            font-size:13px;
        }
        #customerList li:hover{background:#f1f1f1;}
        .cust-info { flex-grow: 1; cursor: pointer; }
        .cust-id{font-weight:bold;color:#333;}
        .cust-name{color:#555;margin-left:6px;}
        
        /* MOBILE TABLE CARD STYLE */
        @media(max-width:768px){
            table,thead,tbody,th,td,tr{display:block;}
            thead tr{position:absolute;top:-9999px;left:-9999px;}
            tr{
                border:1px solid #ddd;
                margin-bottom:10px;
                border-radius:8px;
                padding:8px;
                background:#fff;
            }
            td{
                border:none;
                position:relative;
                padding-left:40%;
                text-align:right;
                font-size:13px;
            }
            td:before{
                content:attr(data-label);
                position:absolute;
                left:8px;
                width:35%;
                font-weight:600;
                color:#555;
                white-space:nowrap;
            }
        }
        /* BILL AREA */
        #billContainer,#customerBillContainer{
            background:#fff;
            padding:10px;
            border-radius:8px;
            box-shadow:0 3px 10px rgba(0,0,0,0.08);
            font-size:13px;
        }
        #billContainer h3,#customerBillContainer h3{margin-bottom:5px;}
        #billContainer p,#customerBillContainer p{margin:2px 0;}
        ::-webkit-scrollbar{width:6px;}
        ::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px;}
        ::-webkit-scrollbar-track{background:#f1f1f1;}
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            font-weight: bold; color: #4CAF50;
        }
        .edit-panel {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #90caf9;
        }
        /* Warning Text */
        #securityMsg {
            color: #d32f2f; font-size: 12px; margin-top: 5px; font-weight: bold; text-align: center;
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay"><img src="loading.gif" alt="data loading..."></div>

<div id="loginScreen" class="container">
    <div class="login-container">
        <div class="login-form">
            <h2 style="text-align:center;margin-bottom:15px;">ü•õ Milk Management<br><small style="font-size:12px;color:gray;">Samra Dairy</small></h2>
            <div class="role-selector">
                <button class="role-btn active" onclick="selectRole(event,'admin')">Admin</button>
                <button class="role-btn" onclick="selectRole(event,'customer')">Customer</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label id="roleLabel">Admin Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="securityMsg"></div>
            </form>
            <div id="forgotPasswordBox">
                <button class="link-btn" onclick="showAdminReset()">Forgot admin password?</button>
                <div id="adminResetPanel" class="hidden">
                    <small>Secret code: 1234</small>
                    <div class="form-group">
                        <input type="password" id="adminSecret" placeholder="Secret code">
                    </div>
                    <div class="form-group">
                        <input type="password" id="newAdminPass" placeholder="New admin password">
                    </div>
                    <button class="btn btn-secondary" onclick="resetAdminPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="adminDashboard" class="container dashboard">
    <div class="header">
        <div>
            <h1>Admin Dashboard (Samra)</h1>
            <small id="todayDate"></small>
        </div>
        <div class="logout" onclick="logout()">Logout</div>
    </div>

    <div class="section">
        <h3>Rate & Search</h3>
        <div class="flex">
            <div style="flex:1;min-width:180px;">
                <label>Default Milk Rate (‚Çπ/L)</label>
                <input type="number" id="milkRate" step="0.01">
                <button class="btn btn-secondary btn-small" onclick="updateMilkRate()">Update Default</button>
                <span id="currentRate" style="font-weight:600;color:#4CAF50;margin-left:6px;">...</span>
            </div>
            <div style="flex:1;min-width:180px;">
                <label>Search Customer</label>
                <input type="text" id="searchCustomer" placeholder="Name or ID" oninput="filterCustomerList()">
            </div>
        </div>
    </div>

    <div class="section">
        <h3>Add New Customer</h3>
        <div class="form-row">
            <input type="text" id="newCustomerName" placeholder="Customer name">
            <input type="text" id="newCustomerId" placeholder="Customer ID">
            <input type="password" id="newCustomerPass" placeholder="Password">
            <button class="btn" onclick="addCustomer()">Add Customer</button>
        </div>
    </div>

    <div class="two-column">
        <div class="section">
            <h3>Customer List</h3>
            <p style="font-size:12px;color:#555;margin-bottom:6px;">Click name to view details.</p>
            <ul id="customerList"></ul>

            <div class="section" style="margin-top:10px;padding:10px;">
                <h4 style="margin-bottom:6px;">Bill History (Selected Customer)</h4>
                <div class="flex" style="margin-bottom:6px;">
                    <button class="btn btn-danger btn-small" onclick="clearAllBillsForSelected()">Clear all bills (this customer)</button>
                </div>
                <div class="table-container">
                    <table id="adminBillHistoryTable">
                        <thead>
                        <tr>
                            <th>From</th><th>To</th><th>Qty</th><th>Total</th><th>Paid</th><th>Bal</th><th>Act</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Customer Records & Bill</h3>
            <div id="noCustomerSelected">Select a customer from the list.</div>
            <div id="customerDetailPanel" class="hidden">
                
                <div class="edit-panel">
                    <h4 style="margin-bottom:8px; color:#1565c0;">Edit Customer Details</h4>
                    <div class="form-row">
                        <div>
                            <label style="font-size:11px;">Name</label>
                            <input type="text" id="editCustName">
                        </div>
                        <div>
                            <label style="font-size:11px;">ID</label>
                            <input type="text" id="editCustId">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label style="font-size:11px;">Password</label>
                            <input type="password" id="editCustPass" placeholder="Reset Password">
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary btn-small" onclick="saveCustomerProfile()">Update Profile</button>
                        </div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="selCustName">-</div>
                        <div id="selCustIdLabel" style="font-size:12px;color:#666;">ID: -</div>
                    </div>
                    <div class="stat-card"><div class="stat-number" id="selCustQty">0 L</div><div>Total Milk</div></div>
                    <div class="stat-card"><div class="stat-number" id="selCustTotal">‚Çπ0</div><div>Total Amount</div></div>
                    <div class="stat-card"><div class="stat-number" id="selCustBalance">‚Çπ0</div><div>Balance</div></div>
                </div>

                <div class="section" style="padding:10px;margin-bottom:10px;">
                    <h4 style="margin-bottom:6px;">Daily Records</h4>
                    <div class="table-container">
                        <table id="selectedCustomerTable">
                            <thead>
                            <tr>
                                <th>Date</th><th>Qty</th><th>Rate</th><th>Total</th><th>Paid</th><th>Balance</th><th>Actions</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="section" style="padding:10px;margin-bottom:10px;">
                    <h4 style="margin-bottom:6px;">Generate or Update Bill (Date Range)</h4>
                    <div class="form-row">
                        <div>
                            <label>Start Date</label>
                            <input type="date" id="billStartDate">
                        </div>
                        <div>
                            <label>End Date</label>
                            <input type="date" id="billEndDate">
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary btn-small" onclick="generateBillForSelected()">Generate / Update</button>
                        </div>
                    </div>
                    <div class="flex">
                        <button class="btn btn-small" onclick="downloadBillPDF('admin')">PDF</button>
                        <button class="btn btn-small btn-secondary" onclick="downloadBillExcel()">Excel</button>
                        <button class="btn btn-small btn-danger" onclick="downloadBillImage('admin')">JPG</button>
                    </div>
                </div>

                <div id="billContainer">
                    <p>No bill selected.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="customerDashboard" class="container dashboard">
    <div class="header">
        <div>
            <h1>Customer Dashboard</h1>
            <small id="custTodayDate"></small>
        </div>
        <div class="logout" onclick="logout()">Logout</div>
    </div>

    <div class="section">
        <h3>Your Info</h3>
        <p><strong>Name:</strong> <span id="custNameLabel">-</span></p>
        <p><strong>ID:</strong> <span id="custIdLabel">-</span></p>
    </div>

    <div class="stats">
        <div class="stat-card"><div class="stat-number" id="custMilkQty">0 L</div><div>Total Milk</div></div>
        <div class="stat-card"><div class="stat-number" id="custRate">View List</div><div>Daily Rates</div></div>
        <div class="stat-card"><div class="stat-number" id="custTotal">‚Çπ0</div><div>Total Amount</div></div>
        <div class="stat-card"><div class="stat-number" id="custBalance">‚Çπ0</div><div>Balance</div></div>
    </div>

    <div class="section">
        <h3>Your Daily Records</h3>
        <div class="table-container">
            <table id="customerRecordsTable">
                <thead>
                <tr><th>Date</th><th>Qty</th><th>Rate</th><th>Total</th><th>Paid</th><th>Balance</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h3>Your Bills History</h3>
        <div class="table-container">
            <table id="customerBillHistoryTable">
                <thead>
                <tr><th>From</th><th>To</th><th>Qty</th><th>Total</th><th>Paid</th><th>Bal</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h3>Selected Bill</h3>
        <div class="flex" style="margin-bottom:8px;">
            <button class="btn btn-small" onclick="downloadBillPDF('customer')">PDF</button>
            <button class="btn btn-small btn-secondary" onclick="downloadBillExcel()">Excel</button>
            <button class="btn btn-small btn-danger" onclick="downloadBillImage('customer')">JPG</button>
        </div>
        <div id="customerBillContainer">
            <p>No bill selected.</p>
        </div>
    </div>
</div>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAvp83Rl2In-YvDsG9PDlZSbTYMJYaE_PM",
        authDomain: "milk-management-system-f646f.firebaseapp.com",
        databaseURL: "https://milk-management-system-f646f-default-rtdb.firebaseio.com",
        projectId: "milk-management-system-f646f",
        storageBucket: "milk-management-system-f646f.firebasestorage.app",
        messagingSenderId: "634029933784",
        appId: "1:634029933784:web:413541139c381770e7c3ad",
        measurementId: "G-1N5DX6YJD7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // CHANGED: Default username to samra
    const defaultAdmin={username:'samra',password:'admin123'};
    const SECRET_CODE='448888';

    // Global variables to hold data
    let adminData = defaultAdmin;
    let customers = [];
    let bills = [];
    let milkRate = 60;

    const demoCustomers=[
        {id:'CUST001',name:'Raj Kumar',password:'1111',records:[
                {date:'2026-01-10',qty:25,rate:60,paid:1200},
                {date:'2026-01-09',qty:20,rate:60,paid:0}
        ]},
        {id:'CUST002',name:'Sunita Devi',password:'2222',records:[
                {date:'2026-01-10',qty:30,rate:60,paid:1500}
        ]}
    ];

    let currentRole='admin';
    let currentUser=null;
    let loggedInCustomerId=null;
    let selectedCustomerIndex=null;
    let lastBill=null; 

    // SECURITY VARIABLES (Stored in LocalStorage to persist refresh)
    let failedAttempts = parseInt(localStorage.getItem('failedAttempts')) || 0;
    let blockUntil = parseInt(localStorage.getItem('blockUntil')) || 0;
    let currentBlockDuration = parseInt(localStorage.getItem('currentBlockDuration')) || 20;

    // ===========================================
    // FIREBASE LISTENERS
    // ===========================================
    
    // 1. Listen for Admin Data
    onValue(ref(db, 'admin'), (snapshot) => {
        const val = snapshot.val();
        if(val) adminData = val;
        else set(ref(db, 'admin'), defaultAdmin);
    });

    // 2. Listen for Milk Rate
    onValue(ref(db, 'settings/milkRate'), (snapshot) => {
        const val = snapshot.val();
        if(val) milkRate = parseFloat(val);
        else set(ref(db, 'settings/milkRate'), 60);
        updateCurrentRateDisplay();
        document.getElementById('loadingOverlay').style.display = 'none';
    });

    // 3. Listen for Customers
    onValue(ref(db, 'customers'), (snapshot) => {
        const val = snapshot.val();
        if(val) {
            customers = val;
        } else {
            customers = demoCustomers;
            saveCustomers();
        }
        
        renderCustomerList();
        
        // Refresh details if open
        if(selectedCustomerIndex !== null) {
            if(customers[selectedCustomerIndex]) {
                showFullCustomer(selectedCustomerIndex);
            } else {
                clearSelectedCustomer();
            }
        }
        
        if(currentUser && currentUser !== 'admin') {
            const freshData = customers.find(c => c.id === currentUser.id);
            if(freshData) {
                currentUser = freshData;
                updateCustomerStats(freshData);
                renderCustomerRecords(freshData.records);
            }
        }
    });

    // 4. Listen for Bills
    onValue(ref(db, 'bills'), (snapshot) => {
        const val = snapshot.val();
        if(val) bills = val;
        else bills = [];

        if(selectedCustomerIndex !== null && customers[selectedCustomerIndex]) {
            renderAdminBillsForCustomer(customers[selectedCustomerIndex].id);
        }
        if(currentUser && currentUser !== 'admin') {
            renderCustomerBills(currentUser.id);
        }
    });


    // ===========================================
    // DATA PERSISTENCE
    // ===========================================
    function saveCustomers(){
        set(ref(db, 'customers'), customers);
    }
    function saveBills(){
        set(ref(db, 'bills'), bills);
    }

    // ===========================================
    // SECURITY LOGIC (BLOCKING SYSTEM)
    // ===========================================

    function checkIsBlocked() {
        const now = Date.now();
        if (now < blockUntil) {
            const remaining = Math.ceil((blockUntil - now) / 1000);
            const msg = `System Blocked! Try again in ${remaining} seconds.`;
            document.getElementById('securityMsg').textContent = msg;
            alert(msg);
            return true;
        }
        document.getElementById('securityMsg').textContent = '';
        return false;
    }

    function handleFailedAttempt() {
        failedAttempts++;
        localStorage.setItem('failedAttempts', failedAttempts);
        
        if (failedAttempts >= 5) {
            const now = Date.now();
            blockUntil = now + (currentBlockDuration * 1000);
            localStorage.setItem('blockUntil', blockUntil);
            
            const msg = `Too many wrong attempts! Blocked for ${currentBlockDuration} seconds.`;
            document.getElementById('securityMsg').textContent = msg;
            alert(msg);

            // Increase duration for next time (Add 20 seconds)
            currentBlockDuration += 20;
            localStorage.setItem('currentBlockDuration', currentBlockDuration);
            
            // Reset attempts so they get 5 tries after the block expires
            failedAttempts = 0;
            localStorage.setItem('failedAttempts', 0);
        } else {
            const left = 5 - failedAttempts;
            const msg = `Wrong credentials! ${left} attempts remaining before block.`;
            document.getElementById('securityMsg').textContent = msg;
            alert(msg);
        }
    }

    function resetSecurityCounters() {
        failedAttempts = 0;
        localStorage.setItem('failedAttempts', 0);
        // We do NOT reset currentBlockDuration here usually, to keep penalties high for repeated abuse,
        // but if you want a successful login to "forgive" the user, uncomment below:
        // currentBlockDuration = 20; 
        // localStorage.setItem('currentBlockDuration', 20);
        document.getElementById('securityMsg').textContent = '';
    }

    // ===========================================
    // UI & LOGIC FUNCTIONS
    // ===========================================

    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('loginForm').addEventListener('submit',handleLogin);
        setTodayDates();
    });

    function setTodayDates(){
        const t=new Date();const s=t.toLocaleDateString('en-IN');
        document.getElementById('todayDate').textContent='Today: '+s;
        document.getElementById('custTodayDate').textContent='Today: '+s;
    }

    // LOGIN
    window.selectRole = function(ev,role){
        currentRole=role;
        document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
        ev.target.classList.add('active');
        const label=document.getElementById('roleLabel');
        const u=document.getElementById('username');
        if(role==='admin'){
            label.textContent='Admin Username (Samra)';
            u.placeholder='Enter admin username';
            document.getElementById('forgotPasswordBox').classList.remove('hidden');
        }else{
            label.textContent='Customer ID';
            u.placeholder='Enter customer ID';
            document.getElementById('forgotPasswordBox').classList.add('hidden');
        }
    }

    function handleLogin(e){
        e.preventDefault();
        
        // 1. Check Block Status
        if(checkIsBlocked()) return;

        const u=document.getElementById('username').value.trim();
        const p=document.getElementById('password').value;
        
        if(currentRole==='admin'){
            if(u===adminData.username && p===adminData.password){
                // Success
                resetSecurityCounters();
                currentUser='admin';
                showDashboard('admin');
            } else {
                // Fail
                handleFailedAttempt();
            }
        }else{
            const c=customers.find(x=>x.id.toUpperCase()===u.toUpperCase());
            if(c && c.password===p){
                // Success (Customer doesn't trigger admin security block, but good practice to reset)
                currentUser=c;
                loggedInCustomerId=c.id;
                showCustomerDashboard(c.id);
            }else {
                alert('Invalid customer ID or password');
            }
        }
    }

    function showDashboard(role){
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('adminDashboard').style.display=role==='admin'?'block':'none';
        document.getElementById('customerDashboard').style.display=role==='customer'?'block':'none';
        if(role==='admin'){
            renderCustomerList();
            clearSelectedCustomer();
        }
    }

    function showCustomerDashboard(id){
        const c=customers.find(x=>x.id===id);
        if(!c)return;
        document.getElementById('custNameLabel').textContent=c.name;
        document.getElementById('custIdLabel').textContent=c.id;
        updateCustomerStats(c);
        renderCustomerRecords(c.records || []);
        renderCustomerBills(id);
        lastBill=null;
        document.getElementById('customerBillContainer').innerHTML='<p>No bill selected.</p>';
        showDashboard('customer');
    }

    window.logout = function(){
        currentUser=null;loggedInCustomerId=null;selectedCustomerIndex=null;lastBill=null;
        document.getElementById('loginScreen').style.display='block';
        document.getElementById('adminDashboard').style.display='none';
        document.getElementById('customerDashboard').style.display='none';
        document.getElementById('loginForm').reset();
        document.getElementById('securityMsg').textContent = '';
    }

    // ADMIN PASSWORD RESET
    window.showAdminReset = function(){document.getElementById('adminResetPanel').classList.toggle('hidden');}
    window.resetAdminPassword = function(){
        // 1. Check Block Status
        if(checkIsBlocked()) return;

        const s=document.getElementById('adminSecret').value;
        const np=document.getElementById('newAdminPass').value;
        
        if(s!==SECRET_CODE){
            handleFailedAttempt();
            return;
        }
        
        if(!np){alert('Enter new password');return;}
        
        // Success
        resetSecurityCounters();
        set(ref(db, 'admin/password'), np);
        alert('Admin password changed');
        document.getElementById('adminResetPanel').classList.add('hidden');
    }

    // RATE
    window.updateMilkRate = function(){
        const v=parseFloat(document.getElementById('milkRate').value);
        if(!v||v<=0){alert('Enter valid rate');return;}
        set(ref(db, 'settings/milkRate'), v);
        alert('Default milk rate updated');
    }
    function updateCurrentRateDisplay(){
        document.getElementById('currentRate').textContent='‚Çπ'+milkRate.toFixed(2);
    }

    // CUSTOMER CRUD
    window.addCustomer = function(){
        const name=document.getElementById('newCustomerName').value.trim();
        const id=document.getElementById('newCustomerId').value.trim().toUpperCase();
        const pass=document.getElementById('newCustomerPass').value;
        if(!name||!id||!pass){alert('Fill all fields');return;}
        if(customers.find(c=>c.id===id)){alert('ID already exists');return;}
        const today=new Date().toISOString().split('T')[0];
        
        const newC = {id,name,password:pass,records:[{date:today,qty:0,rate:milkRate,paid:0}]};
        customers.push(newC);
        
        saveCustomers();
        document.getElementById('newCustomerName').value='';
        document.getElementById('newCustomerId').value='';
        document.getElementById('newCustomerPass').value='';
        alert('Customer added');
    }

    window.saveCustomerProfile = function(){
        if(selectedCustomerIndex === null) return;
        
        const newName = document.getElementById('editCustName').value.trim();
        const newId = document.getElementById('editCustId').value.trim().toUpperCase();
        const newPass = document.getElementById('editCustPass').value;
        const oldId = customers[selectedCustomerIndex].id;

        if(!newName || !newId) { alert("Name and ID cannot be empty"); return; }

        if(newId !== oldId) {
            const exists = customers.find(c => c.id === newId);
            if(exists) { alert("Customer ID already exists!"); return; }
        }

        customers[selectedCustomerIndex].name = newName;
        customers[selectedCustomerIndex].id = newId;
        if(newPass) {
            customers[selectedCustomerIndex].password = newPass;
        }

        if(newId !== oldId) {
            let billsUpdated = false;
            bills.forEach(b => {
                if(b.customerId === oldId) {
                    b.customerId = newId;
                    b.customerName = newName;
                    billsUpdated = true;
                }
            });
            if(billsUpdated) saveBills();
        }

        saveCustomers();
        alert("Customer profile updated!");
        document.getElementById('editCustPass').value = '';
    }

    window.deleteCustomer = function(event, index){
        event.stopPropagation(); 
        const c = customers[index];
        if(!confirm(`Are you sure you want to PERMANENTLY DELETE ${c.name} (${c.id})? This cannot be undone.`)) return;
        
        customers.splice(index, 1);
        saveCustomers();
        
        if(confirm(`Do you also want to delete all bills for ${c.id}?`)){
            bills = bills.filter(b => b.customerId !== c.id);
            saveBills();
        }

        selectedCustomerIndex = null;
        clearSelectedCustomer();
    }

    // CUSTOMER LIST RENDER
    function renderCustomerList(){
        const ul=document.getElementById('customerList');
        ul.innerHTML='';
        customers.forEach((c,idx)=>{
            const li=document.createElement('li');
            li.innerHTML=`
                <div class="cust-info" onclick="showFullCustomer(${idx})">
                    <span class="cust-id">${c.id}</span>
                    <span class="cust-name">${c.name}</span>
                </div>
                <button class="btn btn-danger btn-small" style="width:auto; margin-left:8px;" onclick="deleteCustomer(event, ${idx})">üóëÔ∏è</button>
            `;
            ul.appendChild(li);
        });
        filterCustomerList();
    }

    window.filterCustomerList = function(){
        const term=document.getElementById('searchCustomer').value.trim().toUpperCase();
        const lis=document.querySelectorAll('#customerList li');
        lis.forEach(li=>{
            const text=li.innerText.toUpperCase();
            li.style.display=text.includes(term)?'flex':'none'; 
        });
    }

    // FULL RECORDS FOR SELECTED CUSTOMER
    window.showFullCustomer = function(ci){
        selectedCustomerIndex=ci;
        const c=customers[ci];
        if(!c) return;

        document.getElementById('noCustomerSelected').classList.add('hidden');
        document.getElementById('customerDetailPanel').classList.remove('hidden');

        document.getElementById('editCustName').value = c.name;
        document.getElementById('editCustId').value = c.id;

        let tq=0,ta=0,tp=0;
        const records = c.records || [];
        records.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        
        document.getElementById('selCustName').textContent=c.name;
        document.getElementById('selCustIdLabel').textContent='ID: '+c.id;
        document.getElementById('selCustQty').textContent=tq.toFixed(1)+' L';
        document.getElementById('selCustTotal').textContent='‚Çπ'+ta.toFixed(2);
        document.getElementById('selCustBalance').textContent='‚Çπ'+(ta-tp).toFixed(2);

        const tbody=document.querySelector('#selectedCustomerTable tbody');
        tbody.innerHTML='';
        records.forEach((r,ri)=>{
            const total=r.qty*r.rate;
            const bal=total-r.paid;
            const row=tbody.insertRow();
            
            row.innerHTML=`
<td data-label="Date">${r.date}</td>
<td data-label="Qty"><input type="number" value="${r.qty}" min="0" step="0.1" style="width:70px;" onchange="updateQty(${ci},${ri},this.value)"></td>
<td data-label="Rate"><input type="number" value="${r.rate}" min="0" step="0.01" style="width:70px;" onchange="updateRecordRate(${ci},${ri},this.value)"></td>
<td data-label="Total">‚Çπ${total.toFixed(2)}</td>
<td data-label="Paid"><input type="number" value="${r.paid}" min="0" step="0.01" style="width:70px;" onchange="updatePaid(${ci},${ri},this.value)"></td>
<td data-label="Balance">‚Çπ${bal.toFixed(2)}</td>
<td data-label="Actions">
<button class="btn btn-secondary btn-small" onclick="addRecord(${ci})">+</button>
<button class="btn btn-danger btn-small" onclick="deleteRecord(${ci},${ri})">X</button>
</td>`;
        });

        renderAdminBillsForCustomer(c.id);
        lastBill=null;
        document.getElementById('billContainer').innerHTML='<p>No bill selected.</p>';
    }

    function clearSelectedCustomer(){
        document.getElementById('customerDetailPanel').classList.add('hidden');
        document.getElementById('noCustomerSelected').classList.remove('hidden');
        const tb=document.querySelector('#adminBillHistoryTable tbody');
        tb.innerHTML='';
    }

    window.updateQty = function(ci,ri,val){
        if(!customers[ci].records) customers[ci].records = [];
        customers[ci].records[ri].qty=parseFloat(val)||0;
        saveCustomers();
    }
    
    window.updateRecordRate = function(ci,ri,val){
        if(!customers[ci].records) customers[ci].records = [];
        customers[ci].records[ri].rate=parseFloat(val)||0;
        saveCustomers();
    }

    window.updatePaid = function(ci,ri,val){
        if(!customers[ci].records) customers[ci].records = [];
        customers[ci].records[ri].paid=parseFloat(val)||0;
        saveCustomers();
    }
    window.addRecord = function(ci){
        const today=new Date().toISOString().split('T')[0];
        if(!customers[ci].records) customers[ci].records = [];
        customers[ci].records.push({date:today,qty:0,rate:milkRate,paid:0});
        saveCustomers();
    }
    window.deleteRecord = function(ci,ri){
        if(!confirm('Delete record?'))return;
        customers[ci].records.splice(ri,1);
        saveCustomers();
    }

    // CUSTOMER VIEW
    function updateCustomerStats(c){
        let tq=0,ta=0,tp=0;
        const records = c.records || [];
        records.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        document.getElementById('custMilkQty').textContent=tq.toFixed(1)+' L';
        document.getElementById('custTotal').textContent='‚Çπ'+ta.toFixed(2);
        document.getElementById('custBalance').textContent='‚Çπ'+(ta-tp).toFixed(2);
    }
    function renderCustomerRecords(records){
        const tbody=document.querySelector('#customerRecordsTable tbody');
        tbody.innerHTML='';
        if(!records) return;
        records.forEach(r=>{
            const total=r.qty*r.rate;const bal=total-r.paid;
            const row=tbody.insertRow();
            row.innerHTML=`
<td data-label="Date">${r.date}</td>
<td data-label="Qty">${r.qty}</td>
<td data-label="Rate">‚Çπ${r.rate.toFixed(2)}</td>
<td data-label="Total">‚Çπ${total.toFixed(2)}</td>
<td data-label="Paid">‚Çπ${r.paid.toFixed(2)}</td>
<td data-label="Balance">‚Çπ${bal.toFixed(2)}</td>`;
        });
    }

    // BILL GENERATION / UPDATE
    window.generateBillForSelected = function(){
        if(selectedCustomerIndex===null){alert('Select customer first');return;}
        const c=customers[selectedCustomerIndex];
        const records = c.records || [];
        const sd=document.getElementById('billStartDate').value;
        const ed=document.getElementById('billEndDate').value;
        if(!sd||!ed){alert('Select start and end date');return;}
        const sDate=new Date(sd),eDate=new Date(ed);
        if(sDate>eDate){alert('Start date must be before end date');return;}

        const filtered=records.filter(r=>{
            const d=new Date(r.date);
            return d>=sDate && d<=eDate;
        });
        if(filtered.length===0){alert('No records in this date range');}

        let tq=0,ta=0,tp=0;
        filtered.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        const bal=ta-tp;

        let existing=bills.find(b=>b.customerId===c.id && b.startDate===sd && b.endDate===ed);
        if(existing){
            existing.records=filtered;
            existing.totalQty=tq;
            existing.totalAmount=ta;
            existing.totalPaid=tp;
            existing.balance=bal;
            existing.customerName = c.name; 
            lastBill=existing;
            alert('Bill updated for same date range');
        }else{
            const bill={
                id:'B'+Date.now(),
                customerId:c.id,
                customerName:c.name,
                startDate:sd,
                endDate:ed,
                records:filtered,
                totalQty:tq,
                totalAmount:ta,
                totalPaid:tp,
                balance:bal
            };
            bills.push(bill);
            lastBill=bill;
            alert('Bill generated and saved');
        }
        saveBills();
        renderBillHTML(lastBill,'billContainer');
    }

    // RENDER BILL HTML
    function renderBillHTML(bill,containerId){
        const div=document.getElementById(containerId);
        if(!bill || !bill.records || bill.records.length===0){div.innerHTML='<p>No bill selected.</p>';return;}
        let rows='';
        bill.records.forEach(r=>{
            const t=r.qty*r.rate;const b=t-r.paid;
            rows+=`<tr>
<td style="border:1px solid #ccc;padding:4px;">${r.date}</td>
<td style="border:1px solid #ccc;padding:4px;">${r.qty}</td>
<td style="border:1px solid #ccc;padding:4px;">‚Çπ${r.rate.toFixed(2)}</td>
<td style="border:1px solid #ccc;padding:4px;">‚Çπ${t.toFixed(2)}</td>
<td style="border:1px solid #ccc;padding:4px;">‚Çπ${r.paid.toFixed(2)}</td>
<td style="border:1px solid #ccc;padding:4px;">‚Çπ${b.toFixed(2)}</td>
</tr>`;
        });
        div.innerHTML=`
<h3>Milk Bill</h3>
<p><strong>Customer:</strong> ${bill.customerName} (${bill.customerId})</p>
<p><strong>Duration:</strong> ${bill.startDate} to ${bill.endDate}</p>
<table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:12px;">
<thead><tr style="background:#eee;">
<th style="border:1px solid #ccc;padding:4px;">Date</th>
<th style="border:1px solid #ccc;padding:4px;">Qty</th>
<th style="border:1px solid #ccc;padding:4px;">Rate</th>
<th style="border:1px solid #ccc;padding:4px;">Total</th>
<th style="border:1px solid #ccc;padding:4px;">Paid</th>
<th style="border:1px solid #ccc;padding:4px;">Balance</th>
</tr></thead>
<tbody>${rows}</tbody></table>
<p style="margin-top:6px;"><strong>Total Qty:</strong> ${bill.totalQty.toFixed(1)} L</p>
<p><strong>Total Amount:</strong> ‚Çπ${bill.totalAmount.toFixed(2)}</p>
<p><strong>Total Paid:</strong> ‚Çπ${bill.totalPaid.toFixed(2)}</p>
<p><strong>Balance:</strong> ‚Çπ${bill.balance.toFixed(2)}</p>`;
    }

    function renderAdminBillsForCustomer(customerId){
        const tbody=document.querySelector('#adminBillHistoryTable tbody');
        tbody.innerHTML='';
        bills.filter(b=>b.customerId===customerId).forEach(b=>{
            const tr=tbody.insertRow();
            tr.innerHTML=`
<td data-label="From">${b.startDate}</td>
<td data-label="To">${b.endDate}</td>
<td data-label="Qty">${b.totalQty.toFixed(1)}</td>
<td data-label="Total">‚Çπ${b.totalAmount.toFixed(2)}</td>
<td data-label="Paid">‚Çπ${b.totalPaid.toFixed(2)}</td>
<td data-label="Bal">‚Çπ${b.balance.toFixed(2)}</td>
<td data-label="Act">
<button class="btn btn-secondary btn-small" onclick="selectBill('${b.id}','admin')">Open</button>
<button class="btn btn-danger btn-small" onclick="deleteBill('${b.id}')">Del</button>
</td>`;
        });
    }

    window.clearAllBillsForSelected = function(){
        if(selectedCustomerIndex===null){alert('Select customer first');return;}
        const c=customers[selectedCustomerIndex];
        if(!confirm('Delete all bills for '+c.name+'?'))return;
        bills=bills.filter(b=>b.customerId!==c.id);
        saveBills();
        renderAdminBillsForCustomer(c.id);
        lastBill=null;
        document.getElementById('billContainer').innerHTML='<p>No bill selected.</p>';
    }

    window.deleteBill = function(id){
        const b=bills.find(x=>x.id===id);
        if(!b)return;
        if(!confirm('Delete this bill?'))return;
        bills=bills.filter(x=>x.id!==id);
        saveBills();
    }

    function renderCustomerBills(customerId){
        const tbody=document.querySelector('#customerBillHistoryTable tbody');
        tbody.innerHTML='';
        bills.filter(b=>b.customerId===customerId).forEach(b=>{
            const tr=tbody.insertRow();
            tr.onclick=()=>selectBill(b.id,'customer');
            tr.style.cursor='pointer';
            tr.innerHTML=`
<td data-label="From">${b.startDate}</td>
<td data-label="To">${b.endDate}</td>
<td data-label="Qty">${b.totalQty.toFixed(1)}</td>
<td data-label="Total">‚Çπ${b.totalAmount.toFixed(2)}</td>
<td data-label="Paid">‚Çπ${b.totalPaid.toFixed(2)}</td>
<td data-label="Bal">‚Çπ${b.balance.toFixed(2)}</td>`;
        });
    }

    window.selectBill = function(id,side){
        const b=bills.find(x=>x.id===id);
        if(!b)return;
        lastBill=b;
        if(side==='admin'){
            renderBillHTML(b,'billContainer');
        }else{
            renderBillHTML(b,'customerBillContainer');
        }
    }

    window.downloadBillPDF = async function(role){
        if(!lastBill){alert('No bill to download');return;}
        const id=role==='admin'?'billContainer':'customerBillContainer';
        const el=document.getElementById(id);
        const {jsPDF}=window.jspdf;
        const canvas=await html2canvas(el);
        const img=canvas.toDataURL('image/png');
        const pdf=new jsPDF('p','mm','a4');
        const w=pdf.internal.pageSize.getWidth();
        const props=pdf.getImageProperties(img);
        const ratio=props.height/props.width;
        const h=w*ratio;
        pdf.addImage(img,'PNG',0,0,w,h);
        pdf.save(`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.pdf`);
    }

    window.downloadBillImage = async function(role){
        if(!lastBill){alert('No bill to download');return;}
        const id=role==='admin'?'billContainer':'customerBillContainer';
        const el=document.getElementById(id);
        const canvas=await html2canvas(el);
        const link=document.createElement('a');
        link.href=canvas.toDataURL('image/jpeg');
        link.download=`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.jpg`;
        link.click();
    }

    window.downloadBillExcel = function(){
        if(!lastBill){alert('No bill to download');return;}
        const data=lastBill.records.map(r=>{
            const total=r.qty*r.rate;const bal=total-r.paid;
            return{Date:r.date,Quantity:r.qty,Rate:r.rate,Total:total,Paid:r.paid,Balance:bal};
        });
        data.push({
            Date:'TOTAL',
            Quantity:lastBill.totalQty,
            Rate:'',
            Total:lastBill.totalAmount,
            Paid:lastBill.totalPaid,
            Balance:lastBill.balance
        });
        const ws=XLSX.utils.json_to_sheet(data);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'Bill');
        XLSX.writeFile(wb,`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.xlsx`);
    }
</script>
</body>
</html>
